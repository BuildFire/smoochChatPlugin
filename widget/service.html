<!DOCTYPE html>
<html>
<head>

  <meta name="buildfire" content="disableTheme,disableFastClick">

  <!-- JS -->

  <script src="../../../scripts/buildfire.js"></script>
  <script src="https://cdn.smooch.io/smooch.min.js"></script>
  <!--
  <script src="../../../scripts/angular/angular.min.js"></script>
  <script src="../../../scripts/jquery/jquery-1.11.2.min.js"></script>
  -->

  <script>
    var smoochApp = {};
    buildfire.datastore.get('smoochChatInfo', function (err, obj) {
      if (obj) {
        var initObj = {};
        if (obj.data.settings.type == "Private") {
          initObj.appToken = obj.data.settings.apiKey;
          initObj.customText = {headerText: obj.data.settings.headerText || "How can we help?"};

          buildfire.auth.getCurrentUser(function (err, user) {
            if (user) {
              initObj.givenName = user.displayName;
              initObj.email = user.email;
              initObj.userId = user._id;
            } else {
              try {
                var randomId = JSON.parse(localStorage.getItem('smoochUserRandomId'));
              } catch (e) {
                console.log("Error while parsing value: ", e);
              }
              console.log("****************", randomId);
              if (randomId && randomId.id) {
                initObj.userId = randomId.id;
              }
            }
            
            Smooch.on('message:received', function (message) {
              console.log('the user received a message', message);
              console.log('------------------------', obj.id);


              console.log("InstanceId :::::::::",buildfire.context.instanceId);
              console.log('your data has saved successfully');

              buildfire.datastore.getWithDynamicData("smoochChatInfo", function(err, result) {
                console.log('Dynamic  data::::::::::::::::::', error, result);
              });

              buildfire.pluginInstance.get([buildfire.context.instanceId], function (error, instances) {
                      console.log('Instance data::::::::::::::::::', error, instances);
                      if(instances && !error){
                        buildfire.navigation.navigateTo({
                          pluginId: instances[0].pluginId,
                          instanceId: data.instanceId,
                          title: instances[0].title
                        });
                      }
                    })
            });

            smoochApp = Smooch.init(initObj);
          });
        }
      }
    });

  </script>

</head>

</html>